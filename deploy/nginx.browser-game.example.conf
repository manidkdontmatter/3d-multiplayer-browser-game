# Example Nginx config for production deployment on a single domain.
#
# This dynamic variant avoids hardcoding map instance ids.
# It uses:
# - HTTP server on 443 for game client + orchestrator bootstrap endpoints.
# - Stream TLS passthrough/proxy for a WS port range used by map processes.
#
# Assumptions:
# - Static client build is at /var/www/browser-game/dist
# - Orchestrator HTTP is on 127.0.0.1:9000
# - Map processes bind localhost ports inside 9001-9300
# - Orchestrator env includes:
#     ORCH_PUBLIC_WS_URL_TEMPLATE=wss://game.example.com:{port}
#
# Note:
# - Open firewall/security group for TCP 443 and TCP 9001-9300.
# - Certificates are reused for HTTP and stream TLS listeners.

server {
    listen 80;
    server_name game.example.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name game.example.com;

    ssl_certificate /etc/letsencrypt/live/game.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/game.example.com/privkey.pem;

    root /var/www/browser-game/dist;
    index index.html;

    location /runtime-assets/ {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
    }

    location /runtime-manifests/ {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=60, must-revalidate" always;
        etag on;
    }

    location /assets/ {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=300" always;
    }

    location = /bootstrap {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:9000/bootstrap;
    }

    location = /health {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:9000/health;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }
}

stream {
    server {
        listen 9001-9300 ssl;

        ssl_certificate /etc/letsencrypt/live/game.example.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/game.example.com/privkey.pem;

        # 1:1 forward same public port to localhost port used by map process.
        proxy_pass 127.0.0.1:$server_port;
        proxy_connect_timeout 5s;
        proxy_timeout 600s;
    }
}
